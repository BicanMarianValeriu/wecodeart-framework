<?php
/**
 * WeCodeArt Framework
 *
 * WARNING: This file is part of the core WeCodeArt Framework. DO NOT edit this file under any circumstances.
 * Please do all modifications in the form of a child theme.
 *
 * @package 	WeCodeArt Framework 
 * @subpackage 	Functions
 * @copyright   Copyright (c) 2021, WeCodeArt Framework
 * @since		4.1.8
 * @version     4.1.8
 */

namespace WeCodeArt\Functions;

defined( 'ABSPATH' ) || exit();

/**
 * Helper function to encode an array to an excaped json string
 * Useful to use it for placing encoded object in html attrs
 *
 * @since	3.5
 * @param 	array $json
 *
 * @return 	string 
 */
function toJSON( $json = array() ) {
    if( ! is_array( $json ) ) return null;
    $json = str_replace( '"', "'", json_encode( $json ) );
    return htmlspecialchars( $json, ENT_QUOTES, 'UTF-8' );
}

/**
 * Detect active plugin by constant, class or function existence.
 *
 * @since 	3.5
 * @param 	array 	$plugins 	Array of array for constants, classes and / or functions to check for plugin existence
 * 
 * @return 	boolean
 */
function detect_plugin( array $plugins ) {
    // Check for classes.
    if ( isset( $plugins['classes'] ) ) foreach ( $plugins['classes'] as $name ) if ( class_exists( $name ) ) return true;

    // Check for functions.
    if ( isset( $plugins['functions'] ) ) foreach ( $plugins['functions'] as $name ) if ( function_exists( $name ) ) return true;

    // Check for constants.
    if ( isset( $plugins['constants'] ) ) foreach ( $plugins['constants'] as $name ) if ( defined( $name ) ) return true;

    // No class, function or constant found to exist.
    return false;
}

/**
 * Trim CSS
 *
 * @since 	3.7.7
 * @version 4.2.0
 * @param 	string $css CSS content to trim.
 *
 * @return 	string
 */
function compress_css( $css = '' ) {
    // Return if no CSS
    if ( ! $css ) {
        return '';
    }

    // remove comments
    $css = preg_replace( '!/\*[^*]*\*+([^/][^*]*\*+)*/!', '', $css );

    // Normalize whitespace
    $css = preg_replace( '/\s+/', ' ', $css );

    // Remove ; before }
    $css = preg_replace( '/;(?=\s*})/', '', $css );

    // Remove space after , : ; { } */ >
    $css = preg_replace( '/(,|:|;|\{|}|\*\/|>) /', '$1', $css );

    // Remove space before , ; { }
    $css = preg_replace( '/ (,|;|\{|})/', '$1', $css );

    // Strips leading 0 on decimal values (converts 0.5px into .5px)
    $css = preg_replace( '/(:| )0\.([0-9]+)(%|em|rem|ex|px|in|cm|mm|pt|pc)/i', '${1}.${2}${3}', $css );

    // Strips units if value is 0 (converts 0px to 0)
    $css = preg_replace( '/(:| )(\.?)0(%|em|rem|ex|px|in|cm|mm|pt|pc)/i', '${1}0', $css );

    // Trim
    $css = trim( $css );
    
    // Double call for media queries
    $css = clean_empty_css( $css );
    $css = clean_empty_css( $css );

    // Return minified CSS
    return $css;
}

/**
 * Get CSS without empty selector
 * Call after minification of CSS
 *
 * @since   4.2.0
 * @access  public
 *
 * @param   string $minified_css
 * @return  string
 */
function clean_empty_css( $minified_css ) {
    $css_explode        = explode( '}', $minified_css );
    $result             = '';
    $double_braces_open = false;
    foreach ( $css_explode as $index => $item ) {
        $is_double_braces = substr_count( $item, '{' ) > 1;
        if ( $is_double_braces || ( $item != '' && substr( $item, -1 ) != '{' ) ) {
            if ( $is_double_braces ) {
                $inner_explode = explode( '{', $item );
                $inner_item    = $inner_explode[0] . '{';
                if ( isset( $inner_explode[2] ) && $inner_explode[2] != '' ) {
                    $inner_item .= $inner_explode[1] . '{' . $inner_explode[2] . '}';
                }
                $result .= $inner_item;
            } else {
                $result .= $item . '}';
            }

            if ( $is_double_braces ) {
                $double_braces_open = true;
            }
        }
        if ( $double_braces_open && $item == '' ) {
            $result            .= '}';
            $double_braces_open = false;
        }
    }

    return $result;
}

/**
 * Get a specific property of an array
 *
 * @since  	3.8.1
 *
 * @return null|string|mixed The value
 */
function get_prop( $array, $prop, $default = null ) {
    if ( ! is_array( $array ) && ! ( is_object( $array ) && $array instanceof ArrayAccess ) ) return $default; 
    if ( isset( $array[ $prop ] ) ) $value = $array[ $prop ];
    else $value = ''; 
    return empty( $value ) && null !== $default ? $default : $value;
}
    
/**
 * Kses SVG
 *
 * @param 	string 	$data
 *
 * @return 	string
 */
function kses_svg( string $data ) {
    return wp_kses( $data, [ 
        'svg' => [
            'class'  		=> true,
            'aria-hidden'  	=> true,
            'role' 			=> true,
            'focusable'    	=> true,
            'xmlns'    		=> true,
            'viewbox' 		=> true,
        ],
        'g' 	=> [],
        'path' 	=> [
            'd' 	=> true,
            'class' => true,
            'fill'	=> true
        ]
    ] );
}

/**
 * WP_Parse_Args Reccursive
 *
 * @param 	array 	$a
 * @param 	array 	$b
 *
 * @return 	array
 */
function wp_parse_args_r( &$a, $b ) {
    $a = (array) $a;
    $b = (array) $b;
    $r = $b;

    foreach ( $a as $k => &$v ) {
        if ( is_array( $v ) && isset( $r[ $k ] ) ) {
            $r[ $k ] = wp_parse_args_r( $v, $r[ $k ] );
        } else {
            $r[ $k ] = $v;
        }
    }

    return $r;
}

/**
 * Calc FN
 *
 * @param 	int 	$number1
 * @param 	string 	$action
 * @param 	int 	$number2
 * @param 	bool 	$round
 * @param 	int 	$decimals
 * @param 	int 	$precision
 *
 * @return 	array
 */
function calc( $number1, $action, $number2, $round = false, $decimals = 0, $precision = 10 ) {
    static $bc;

    if ( ! is_scalar( $number1 ) || ! is_scalar( $number2 ) ) {
        return false;
    }

    if ( ! isset( $bc ) ) {
        $bc = extension_loaded( 'bcmath' );
    }

    if ( $bc ) {
        $number1 = number_format( $number1, 10, '.', '' );
        $number2 = number_format( $number2, 10, '.', '' );
    }

    $result  = null;
    $compare = false;

    switch ( $action ) {
    case '+':
    case 'add':
    case 'addition':
        $result = ( $bc ) ? bcadd( $number1, $number2, $precision ) /* string */ : ( $number1 + $number2 );
        break;

    case '-':
    case 'sub':
    case 'subtract':
        $result = ( $bc ) ? bcsub( $number1, $number2, $precision ) /* string */ : ( $number1 - $number2 );
        break;

    case '*':
    case 'mul':
    case 'multiply':
        $result = ( $bc ) ? bcmul( $number1, $number2, $precision ) /* string */ : ( $number1 * $number2 );
        break;

    case '/':
    case 'div':
    case 'divide':
        if ( $bc ) {
            $result = bcdiv( $number1, $number2, $precision ); // String, or NULL if right_operand is 0.
        } elseif ( $number2 != 0 ) {
            $result = ( $number1 / $number2 );
        }

        if ( ! isset( $result ) ) {
            $result = 0;
        }
        break;

    case '%':
    case 'mod':
    case 'modulus':
        if ( $bc ) {
            $result = bcmod( $number1, $number2 ); // String, or NULL if modulus is 0.
        } elseif ( $number2 != 0 ) {
            $result = ( $number1 % $number2 );
        }

        if ( ! isset( $result ) ) {
            $result = 0;
        }
        break;

    case '=':
    case 'comp':
    case 'compare':
        $compare = true;
        if ( $bc ) {
            $result = bccomp( $number1, $number2, $precision ); // Returns int 0, 1 or -1.
        } else {
            $result = ( $number1 == $number2 ) ? 0 : ( ( $number1 > $number2 ) ? 1 : - 1 );
        }
        break;
    }

    if ( isset( $result ) ) {
        if ( $compare === false ) {
            if ( $round === true ) {
                $result = round( floatval( $result ), $decimals );
                if ( $decimals === 0 ) {
                    $result = (int) $result;
                }
            } else {
                $result = ( intval( $result ) == $result ) ? intval( $result ) : floatval( $result );
            }
        }

        return $result;
    }

    return false;
}

/**
 * Convert HEX to RGBA.
 *
 * @param 	string $color   Color data.
 * @param 	bool   $opacity Opacity status.
 *
 * @return 	mixed
 * @since   4.2.0
 * @access  public
 */
function hex_rgba( $color, $opacity = false ) {
    $default = 'rgb(0,0,0)';

    if ( empty( $color ) ) {
        return $default;
    }

    if ( '#' == $color[0] ) {
        $color = substr( $color, 1 );
    }

    if ( strlen( $color ) == 6 ) {
        $hex = array( $color[0] . $color[1], $color[2] . $color[3], $color[4] . $color[5] );
    } elseif ( strlen( $color ) == 3 ) {
        $hex = array( $color[0] . $color[0], $color[1] . $color[1], $color[2] . $color[2] );
    } else {
        return $default;
    }

    $rgb = array_map( 'hexdec', $hex );

    if ( $opacity ) {
        if ( abs( $opacity ) > 1 ) {
            $opacity = 1.0;
        }
        $output = 'rgba(' . implode( ',', $rgb ) . ',' . $opacity . ')';
    } else {
        $output = 'rgb(' . implode( ',', $rgb ) . ')';
    }

    return $output;
}

/**
 * Sanitize rgba color.
 *
 * @param string $value Color in rgba format.
 *
 * @return string
 */
function sanitize_rgba( $value ) {
    $red   = 'rgba(0,0,0,0)';
    $green = 'rgba(0,0,0,0)';
    $blue  = 'rgba(0,0,0,0)';
    $alpha = 'rgba(0,0,0,0)'; // If empty or an array return transparent
    
    if ( empty( $value ) || is_array( $value ) ) {
        return '';
    }

    // By now we know the string is formatted as an rgba color so we need to further sanitize it.
    $value = str_replace( ' ', '', $value );
    sscanf( $value, 'rgba(%d,%d,%d,%f)', $red, $green, $blue, $alpha );

    return 'rgba(' . $red . ',' . $green . ',' . $blue . ',' . $alpha . ')';
}