<?php
/**
 * WeCodeArt Framework.
 *
 * WARNING: This file is part of the core WeCodeArt Framework. DO NOT edit this file under any circumstances.
 * Please do all modifications in the form of a child theme.
 *
 * @package 	WeCodeArt Framework
 * @subpackage 	Customizer/Choices AJAX
 * @copyright   Copyright (c) 2021, WeCodeArt Framework
 * @since 		5.0.0
 * @version		5.0.0
 */

namespace WeCodeArt\Admin\Customizer\Requests;

defined( 'ABSPATH' ) || exit;

use WeCodeArt\Singleton;
use WeCodeArt\Admin\Request\Async;
use function WeCodeArt\Functions\get_prop;
use function WeCodeArt\Functions\set_settings_array;

/**
 * This class handles a post request being send to a given endpoint.
 */
class Choices extends Async {

    /**
     * Prefix
     *
     * @var     string
     * @access  protected
     */
    protected $prefix = 'wca';

    /**
     * Action
     *
     * @var     string
     * @access  protected
     */
    protected $action = 'update_choices';

    /**
     * Handle
     * 
     * @return  mixed
     */
    protected function handle() {
        $action     = filter_input( INPUT_POST, 'type', FILTER_SANITIZE_STRING );
        $palette    = filter_input( INPUT_POST, 'palette' );
        
		if ( empty( $palette ) ) {
            wp_send_json_error( [
                'message' => esc_html__( 'Missing palette.', 'wecodeart' )
            ] );
        }
            
        $user_custom_post_type_id     = \WP_Theme_JSON_Resolver_Gutenberg::get_user_custom_post_type_id();
		$user_theme_json_post         = get_post( $user_custom_post_type_id );
		$user_theme_json_post_content = json_decode( $user_theme_json_post->post_content );

        $custom_palettes    = wecodeart_json( [ 'settings', 'custom', 'colorPalettes' ], [] );
        if( $action === 'remove' ) {
            $custom_palettes = wp_list_filter( $custom_palettes, [ 'slug' => $palette ], 'NOT' );
        } else if( $action === 'add' ) {
            $custom_palettes[]  = json_decode( $palette );
        }

		$user_theme_json_post_content = set_settings_array(
			$user_theme_json_post_content,
			[ 'settings', 'custom', 'colorPalettes' ],
			$custom_palettes
		);

		// Update the theme.json with the new settings.
		$user_theme_json_post->post_content = json_encode( $user_theme_json_post_content );
        $updated = wp_update_post( $user_theme_json_post );

		if( $updated ) wp_send_json_success();
        wp_send_json_error();
    }
}