<?php
/**
 * WeCodeArt Framework.
 *
 * WARNING: This file is part of the core WeCodeArt Framework. DO NOT edit this file under any circumstances.
 * Please do all modifications in the form of a child theme.
 *
 * @package 	WeCodeArt Framework
 * @subpackage 	Customizer/Ajax
 * @copyright   Copyright (c) 2021, WeCodeArt Framework
 * @since 		5.0.0
 * @version		5.0.0
 */

namespace WeCodeArt\Admin\Customizer\Requests;

defined( 'ABSPATH' ) || exit;

use WeCodeArt\Singleton;
use WeCodeArt\Admin\Request\Async;
use function WeCodeArt\Functions\get_prop;
use function WeCodeArt\Functions\set_settings_array;

/**
 * This class handles a post request being send to a given endpoint.
 */
class Colors extends Async {

    /**
     * Prefix
     *
     * @var     string
     * @access  protected
     */
    protected $prefix = 'wca';

    /**
     * Action
     *
     * @var     string
     * @access  protected
     */
    protected $action = 'update_colors';

    /**
     * Handle
     * 
     * @return  mixed
     */
    protected function handle() {
        $palette    = filter_input( INPUT_POST, 'palette', FILTER_SANITIZE_STRING );
        $colors     = json_decode( filter_input( INPUT_POST, 'colors' ) );
            
        $user_custom_post_type_id     = \WP_Theme_JSON_Resolver_Gutenberg::get_user_custom_post_type_id();
		$user_theme_json_post         = get_post( $user_custom_post_type_id );
		$user_theme_json_post_content = json_decode( $user_theme_json_post->post_content );

        // Update Base
        $user_theme_json_post_content = set_settings_array(
            $user_theme_json_post_content,
            [ 'settings', 'color', 'palette' ],
            $colors
        );

        // Update Choices
        $choices = wecodeart_json( [ 'settings', 'custom', 'colorPalettes' ], [] );
        foreach( $choices as $key => $value ) {
            if( $value['slug'] === $palette ) {
                $choices[$key]['colors'] = wp_list_pluck( $colors, 'color', 'slug' );
                break;
            }
        }

        $user_theme_json_post_content = set_settings_array(
            $user_theme_json_post_content,
            [ 'settings', 'custom', 'colorPalettes' ],
            $choices
        );

		// Update the theme.json with the new settings.
		$user_theme_json_post->post_content = json_encode( $user_theme_json_post_content );
        $updated = wp_update_post( $user_theme_json_post );

		if( $updated ) wp_send_json_success();
        wp_send_json_error();
    }
}