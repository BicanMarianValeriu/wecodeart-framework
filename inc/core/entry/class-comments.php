<?php
/**
 * WeCodeArt Framework.
 *
 * WARNING: This file is part of the core WeCodeArt Framework. DO NOT edit this file under any circumstances.
 * Please do all modifications in the form of a child theme.
 *
 * @package 	WeCodeArt Framework
 * @subpackage 	Core\Entry\Comments
 * @copyright   Copyright (c) 2021, WeCodeArt Framework
 * @since		3.5
 * @version		4.2.0
 */

namespace WeCodeArt\Core\Entry;

defined( 'ABSPATH' ) || exit();

use WeCodeArt\Core\Pagination;
use WeCodeArt\Markup;
use WeCodeArt\Markup\SVG;
use WeCodeArt\Markup\Input;
use WeCodeArt\Markup\Walkers\Comment as CommentWalker;

/**
 * Handles Comments Functionality
 */
class Comments {

	use \WeCodeArt\Singleton;

	/**
	 * Send to Constructor
	 * @since 3.7.0
	 */
	public function init() {
		// WP Core
		add_filter( 'comment_form_fields',	[ $this, 'comment_form_fields' 		] );
		add_filter( 'comment_form_defaults',[ $this, 'comment_form_defaults' 	] );
		add_filter( 'comment_reply_link',	[ $this, 'replace_reply_link_class' ] );
		add_action( 'pre_comment_on_post',  [ $this, 'validate_cookies'			] );

		// WeCodeArt Core
		if( post_password_required() ) {
			add_action( 'wecodeart/entry/comments', [ $this, 'render_protected' ], 20 );
		} else {
			add_action( 'wecodeart/entry/comments', [ $this, 'render_meta'		], 10 );
			add_action( 'wecodeart/entry/comments', [ Pagination::get_instance(), 'comments' ], 15 ); 
			add_action( 'wecodeart/entry/comments', [ $this, 'render_comments'	], 20 );
			add_action( 'wecodeart/entry/comments', [ $this, 'render_pings'		], 30 );
			add_action( 'wecodeart/entry/comments', [ Pagination::get_instance(), 'comments' ], 35 ); 
			add_action( 'wecodeart/entry/comments', [ $this, 'render_respond'	], 40 );
		}
		
		add_action( 'wecodeart/hook/entry/footer', [ $this, 'get_comments_template' ], 30 );
	}
	
	/**
	 * Get the comments template
	 *
	 * @since 	unknown
	 * @version	3.7.0
	 *
	 * @return 	void 
	 */
	public function get_comments_template() {
		// Only if CPT supports and singular entry
		if ( ! post_type_supports( get_post_type(), 'comments' ) && ! is_singular() ) return;
		comments_template( null, true );
	}

	/**
	 * Render Comments Info
	 *
	 * @since	3.7.3
	 * @version	4.2.0
	 *
	 * @return 	string
	 */
	public function get_comments_info( $echo = true ) {

		$comments_number = intval( get_comments_number() );

		$defaults = [
			'icon' 		=> SVG::compile( 'comments', [ 'class' => 'me-2' ] ), // Escaped with kses inside fn.
			'empty' 	=> esc_html__( 'No comments', 'wecodeart' ),
			'closed'	=> false,
			'add_one'	=> esc_html__( 'add one', 'wecodeart' ) 
		]; 

		$args = apply_filters( 'wecodeart/filter/comments/get_comments_info/args', $defaults, get_post_type() );

		$icon_html 	= '';
		$header_tx 	= '';
		if( comments_open() || $comments_number !== 0 ) {
			$icon_html = $args['icon'];
			if ( 0 !== $comments_number ) {
				$header_tx = sprintf(
					_nx( '%1$s comment', '%1$s comments', $comments_number, 'comments title', 'wecodeart' ),
					number_format_i18n( $comments_number )
				);
			} else {
				$header_tx = $args['empty']; 
			} 
		} else {
			if( $args['closed'] !== false && is_string( $args['closed'] ) ) $header_tx = $args['closed']; 
		} 

		// Prepare HTML output
		$output = sprintf( '%1$s %2$s', $icon_html, $header_tx );

		// Append `add comment` link
		if( comments_open() ) {
			$output .= sprintf( '<a class="comments__add-new" href="#respond" rel="nofollow">%s</a>', $args['add_one'] ); 
		}

		$output = apply_filters( 'wecodeart/filter/comments/get_comments_info/output', trim( $output ) );

		if( $echo ) {
			echo $output; // phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
			return;
		}

		return $output; // phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
	} 

	/**
	 * Render Comments List
	 *
	 * @since	unknown
	 * @version 4.1.61
	 *
	 * @return 	void
	 */
	public function render_comments() {
		if ( have_comments() ) {
			Markup::wrap( 'comments-list', [ [
				'tag' 	=> 'ol',
				'attrs' => [
					'id' 	=> 'comments-list',
					'class' => 'comments__list list-unstyled pl-0'
				]
			] ], function() { // Required as this to be read by theme check
				wp_list_comments( apply_filters( 'wecodeart/filter/comments/list/args', [
					'type' 		 	=> 'comment',
					'avatar_size' 	=> 60,
					'walker'		=> new CommentWalker,
				] ) );
			} );
		}
		return;
	}

	/**
	 * Render Pings List.
	 *
	 * @since	unknown
	 * @version 3.7.8
	 *
	 * @return 	void
	 */
	public function render_pings() {
		global $wp_query;

		// If have pings.
		if ( ! empty( $wp_query->comments_by_type['pings'] ) ) {
			Markup::wrap( 'pings-list', [ [
				'tag' 	=> 'ol',
				'attrs' => [
					'id' 	=> 'pings-list',
					'class' => 'comments__pings unstyled pl-0 pings-list'
				]
			] ], 'wp_list_comments', [ apply_filters( 'wecodeart/filter/comments/pings/args', [
				'type' 		 => 'pings',
				'short_ping' => true,
				'walker'	 => new CommentWalker,
			] ) ] );
		}
		return;
	}

	/**
	 * Render Comments Info
	 *
	 * @since	3.7.0
	 *
	 * @return	string	HTML
	 */
	public function render_meta() {  
		Markup::wrap( 'comments-info', [ [
			'tag' 	=> 'h3',
			'attrs' => [
				'id' 	=> 'comments-title',
				'class' => 'comments__headline'
			]
		] ], [ $this, 'get_comments_info' ] );
	}
	
	/**
	 * Render Protected
	 *
	 * @since	4.2.0
	 *
	 * @return	string	HTML
	 */
	public function render_protected() {  
		Markup::wrap( 'comment-form-protected', [ [
			'tag' 	=> 'p',
			'attrs' => [
				'class' => 'alert alert-danger shadow-soft'
			]
		] ], 'printf', [ 
			esc_html__( 'This post is password protected. Enter the password to view comments.', 'wecodeart' )
		] );
	}

	/**
	 * Render Comment Form.
	 *
	 * @since	unknown
	 * @version 4.2.0
	 */
	public function render_respond() {
		// Bail if comments are closed for this post type.
		if ( ( is_singular() && ! comments_open() ) ) return;

		$args = apply_filters( 'wecodeart/filter/comments/respond/args', [
			'format'			 	=> 'html5',
			'title_reply_before' 	=> '<h3 id="reply-title" class="comments__respond-headline">',
			'title_reply_after'  	=> '</h3>',
			'class_container'		=> 'comments__respond mt-3 mb-5',
			'class_form' 			=> 'comments__respond-form comment-form needs-validation',
		] );

		comment_form( $args );
	} 

	/**
	 * Move Comment Field Bellow Name/Email/Website.
	 *
	 * @since	unknown
	 * @version 4.2.0
	 *
	 * @param 	array $fields
	 *
	 * @return 	array
	 */
	public function comment_form_fields( $fields ) {
		$comment_field = $fields['comment'];
		$cookies_field = $fields['cookies'];
		unset( $fields['comment'], $fields['cookies'] );
		
		$fields['comment'] = $comment_field;
		$fields['cookies'] = $cookies_field;
		return $fields;
	}

	/**
	 * Filter Comment Respond Args.
	 *
	 * @since	unknown
	 * @version	4.2.0
	 *
	 * @return 	array
	 */
	public function comment_form_defaults( $defaults ) {
		// Fields escapes all the data for us. 	
		$commenter = wp_get_current_commenter();
		$req       = get_option( 'require_name_email' );

		$inputs = [
			'name' => wecodeart_input( 'text', [
				'label' => esc_html__( 'Name *', 'wecodeart' ),
				'attrs' => [
					'id' 	=> 'comment-author',
					'name' 	=> 'author',
					'required' 	=> ( $req ) ? 'required' : NULL,
					'size' 		=> 30,
					'maxlength' => 245,
					'value' 	=> $commenter['comment_author']
				]
			], false ),
			'email' => wecodeart_input( 'email', [
				'label' => esc_html__( 'Email *', 'wecodeart' ),
				'attrs' => [
					'id' 	=> 'comment-email',
					'name' 	=> 'email',
					'required' 	=> ( $req ) ? 'required' : NULL,
					'size' 		=> 30,
					'maxlength' => 100,
					'value' 	=> $commenter['comment_author_email']
				]
			], false ),
			'url' => wecodeart_input( 'url', [
				'label' => esc_html__( 'Website', 'wecodeart' ),
				'attrs' => [
					'id' 	=> 'comment-url',
					'name' 	=> 'url',
					'size' 		 => 30, 
					'maxlength'  => 200,
					'value' 	 => $commenter['comment_author_url']  
				]
			], false ),
			'comment' => wecodeart_input( 'textarea', [
				'label' => esc_html__( 'Comment *', 'wecodeart' ),
				'attrs' => [
					'id' 	=> 'comment',
					'name' 	=> 'comment',
					'rows'	=> 8,
					'cols'  => 45,
					'required'		=> ( $req ) ? 'required' : NULL,
					'aria-required'	=> 'true'
				]
			], false )
		];

		$author_name	= Markup::wrap( 'comment-author-name', [ [
			'tag' 	=> 'div',
			'attrs' => [
				'class' => 'mb-3 comment-form-author col-12 col-md-7'
			]
		] ], $inputs['name'], null, false );

		// Author Email.
		$author_email = Markup::wrap( 'comment-author-email', [ [
			'tag' 	=> 'div',
			'attrs' => [
				'class' => 'mb-3 comment-form-email col-12 col-md-7'
			]
		] ], $inputs['email'], null, false );

		// Author URL.
		$author_url	= Markup::wrap( 'comment-author-url', [ [
			'tag' 	=> 'div',
			'attrs' => [
				'class' => 'mb-3 comment-form-url col-12 col-md-7'
			]
		] ], $inputs['url'], null, false );

		// The Comment.
		$author_comment	= Markup::wrap( 'comment-field', [ [
			'tag' 	=> 'div',
			'attrs' => [
				'class' => 'mb-3 comment-form-comment'
			]
		] ], $inputs['comment'], null, false );

		// Cookies
		$cookies = false;
		if( $privacy_policy_page = get_option( 'wp_page_for_privacy_policy' ) ) {
			$page_url 	= get_privacy_policy_url();
			$page_title = get_the_title( $privacy_policy_page );
			$page_link  = sprintf( '<a href="%1$s">%2$s</a>', esc_url( $page_url ), esc_html( $page_title ) );
			
			$cookies = Markup::wrap( 'comment-cookies', [ [
				'tag' 	=> 'div',
				'attrs' => [
					'class' => 'mb-3 comment-form-cookies'
				]
			] ], wecodeart_input( 'toggle', [
				'type'	=> 'checkbox',
				'label' => sprintf( __(  'By commenting you accept the %s.', 'wecodeart' ), $page_link ),
				'attrs' => [
					'class'		=> 'form-switch',
					'id' 		=> 'comment-cookies',
					'name' 		=> 'comment-cookies',
					'required'  => ( $req ) ? 'required' : NULL,
					'aria-required'  => 'true',
				]
			], false ), null, false );
		}

		$args = [
			'title_reply' 			=> SVG::compile( 'comment-dots', [ 'class' => 'me-2' ] ) . esc_html__( 'Speak Your Mind', 'wecodeart' ),
			'comment_field' 		=> $author_comment,
			'comment_notes_before' 	=> Markup::wrap( 'comment-notes-before', [ [
				'tag' 	=> 'div',
				'attrs' => [
					'class' => 'mb-3 comment-form-notes'
				]
			] ], function() use ( $req ) {
				$string = esc_html__( 'Your email address will not be published.', 'wecodeart' );
				if( $req ) {
					$string .= ' ' . sprintf( esc_html__( 'Required fiels are marked "%s".', 'wecodeart' ), 
						'<span class="required">*</span>' 
					);
				}
				echo wp_kses_post( $string );
			}, [], false ),
			'comment_notes_after' 	=> Markup::wrap( 'comment-notes-after', [ [
				'tag' 	=> 'div',
				'attrs' => [
					'class' => 'mb-3 comment-form-allowed-tags'
				]
			] ], function() {
				printf( esc_html__( 'You may use these %s tags and attributes: %s.', 'wecodeart' ),
					sprintf( '<abbr data-toggle="tooltip" title="%s">HTML</abbr>', esc_html__( 'HyperText Markup Language', 'wecodeart' ) ),
					'<code>' . allowed_tags() . '</code>'
				);
			}, [], false ),
			'submit_field'         	=> '<div class="mb-3 comment-form-submit">%1$s %2$s</div>',
			'submit_button'         => '<button name="%1$s" type="submit" id="%2$s" class="%3$s">' . SVG::compile( 'comment-dots', [
				'class' => 'me-1'
			] ) . '%4$s</button>',
			'class_submit'         	=> 'btn btn-outline-dark',
			'fields' => [
				'author' 	=> $author_name,
				'email'  	=> $author_email,
				'url'    	=> $author_url,
				'cookies'	=> $cookies,
			]
		];

		// Merge $args with $defaults
		$args = wp_parse_args( $args, $defaults );

		// Return filterable array of $args, along with other optional variables
		return apply_filters( 'wecodeart/filter/comments/form/args', $args, $commenter, $req );
	}

	/**
	 * Replace Comment Reply Button class.
	 *
	 * @since	unknown
	 * @version 3.7.7
	 *
	 * @param 	string $class
	 *
	 * @return 	string
	 */
	public function replace_reply_link_class( $class ) {
		$class = str_replace( "class='comment-reply-link", "class='comment-reply-link btn btn-dark btn-sm", $class );
		return $class;
	}

	/**
	 * Validate Cookie field.
	 *
	 * @since	4.2.0
	 *
	 * @param 	string $class
	 *
	 * @return 	string
	 */
	public function validate_cookies() {
		if( $privacy_policy = get_option( 'wp_page_for_privacy_policy' ) ) {
			$page_url 	= get_privacy_policy_url();
			$page_title = get_the_title( $privacy_policy );
			$page_link  = sprintf( '<a href="%1$s">%2$s</a>', esc_url( $page_url ), esc_html( $page_title ) );

			if( ! filter_input( INPUT_POST, 'comment-cookies' ) ) {
				wp_die( sprintf( esc_html__( 'You must accept %s to comment!', 'wecodeart' ), $page_link ) );
			}
		}
	}
}