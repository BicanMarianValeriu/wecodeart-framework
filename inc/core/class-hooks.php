<?php
/**
 * WeCodeArt Framework.
 *
 * WARNING: This file is part of the core WeCodeArt Framework. DO NOT edit this file under any circumstances.
 * Please do all modifications in the form of a child theme.
 *
 * @package 	WeCodeArt Framework
 * @subpackage 	Core\Hooks
 * @copyright   Copyright (c) 2019, WeCodeArt Framework
 * @since 		3.0
 * @version		4.1.2
 */

namespace WeCodeArt\Core;

defined( 'ABSPATH' ) || exit(); 

use WeCodeArt\Core\Search;
use WeCodeArt\Core\Content;
use WeCodeArt\Markup\SVG;
use WeCodeArt\Walkers\Menu;

/**
 * General Hooks
 */
class Hooks {

	use \WeCodeArt\Singleton;

	/**
	 * Send to Constructor
	 * @since 3.6.2
	 */
	public function init() {
		add_filter( 'body_class',		array( $this, 'body_classes'	) );
		add_filter( 'post_class',		array( $this, 'post_classes'	) );
		add_filter( 'get_search_form',	array( $this, 'search_form' 	) );
		add_filter( 'wp_nav_menu_args',	array( $this, 'menu_args' 		) );
		add_filter( 'wp_get_attachment_image_attributes', [ $this, 'lazy_image_loading' ], 10, 3 );
	}
	
	/**
	 * Adds custom classes to the array of body classes.
	 *
	 * @version 4.0.6
	 *
	 * @param 	array 	$classes Classes for the body element.
	 *
	 * @return 	array
	 */
	public function body_classes( $classes ) {
		// Add a class of hfeed to non-singular pages.
		if ( ! is_singular() ) {
			$classes[] = 'hfeed';
		}
		
		// Adds a class of group-blog to blogs with more than 1 published author.
		if ( is_multi_author() ) {
			$classes[] = 'group-blog';
		}
		
		$modules = Content::get_contextual_options()['modules'];

		// Add sidebar class
		if( in_array( 'primary', $modules, true ) || in_array( 'secondary', $modules, true ) ) {
			$classes[] = 'page--has-sidebar';
		} else {
			$classes[] = 'page--no-sidebar';
		}
		
		// Singular sidebar class if gutenberg wide/full layout/
		if( wecodeart_if( 'is_full_layout' ) ) { 
			$classes = array_diff( $classes, [ 'has-sidebar', 'page--has-sidebar' ] );
			$classes[] = 'page--full-width';
		} 

		// Return Classes.
		$classes = array_map( 'sanitize_html_class', $classes );

		return $classes;
	}
	
	/**
	 * Filter classes to the array of post classes.
	 *
	 * @param 	array $classes Classes for the post.
	 * 
	 * @return 	array
	 */
	public function post_classes( $classes ) {
		if ( is_admin() ) {
			return $classes;
		}
		
		// Add "entry" to the post class array.
		$classes[] = 'entry';

		// Remove "hentry" from post class array.
		$classes = array_diff( $classes, [ 'hentry' ] );
		
		return $classes;
	}
	
	/**
	 * Filter Search form HTML Markup.
	 * 
	 * @since 	unknown
	 * @version 3.9.5
	 * 
	 * @return 	string $form
	 */
	public function search_form() {
		/**
		 * Allow the default form args to be filtered.
		 *
		 * @since 	3.9.3
		 * @version	3.9.5
		 *
		 * @param string The form args.
		 */
		$query_or_placeholder = esc_attr(
			apply_filters( 'the_search_query', get_search_query() )
		) ?: sprintf( __( 'Search this website %s', wecodeart_config( 'textdomain' ) ), '&#x02026;' );

		$form = new Search( apply_filters( 'wecodeart/filter/search_form/i18n', [
			'input'		=> $query_or_placeholder,
			'button'	=> SVG::compile( 'search' ),
		] ) );

		/**
		 * Allow the form output to be filtered.
		 *
		 * @since 3.9.3
		 *
		 * @param string The form markup.
		 */
		return apply_filters( 'wecodeart/filter/search_form/html', $form->get_form() );
	}

	/**
	 * Adds Walker to WP Menus by default.
	 *
	 * @since 	4.0.5
	 *
	 * @param 	array 	$args.
	 *
	 * @return 	array
	 */
	public function menu_args( $args ) {
		return wp_parse_args( [
			'walker' 		 => new Menu,
			'fallback_cb'	 => 'WeCodeArt\Walkers\Menu::fallback'
		], $args );
	}

	/**
	 * Filter the attributes of all images retrieved with `wp_get_attachment_image`,
	 * add `loading="lazy"` to enable lazy loading in Chrome.
	 *
	 * @since 4.1.2
	 *
	 * @param 	array $attr Attributes for the image markup.
	 *
	 * @return 	array The filtered $attr array.
	 */
	public function lazy_image_loading( $attr ) {
		if ( ! current_theme_supports( 'wecodeart-lazy-images' ) ) {
			return $attr;
		}

		$attr['loading'] = 'lazy';

		return $attr;
	}
}