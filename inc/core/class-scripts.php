<?php
/**
 * WeCodeArt Framework.
 *
 * WARNING: This file is part of the core WeCodeArt Framework. DO NOT edit this file under any circumstances.
 * Please do all modifications in the form of a child theme.
 *
 * @package 	WeCodeArt Framework
 * @subpackage 	Core\Scripts
 * @copyright   Copyright (c) 2019, WeCodeArt Framework
 * @since 		1.9
 * @version		3.9.3
 */ 

namespace WeCodeArt\Core;

defined( 'ABSPATH' ) || exit();

use WeCodeArt\Utilities\Markup;

/**
 * Framework Assets
 */
class Scripts {

	use \WeCodeArt\Singleton;

	/**
	 * Send to Constructor
	 * @since 3.6.2
	 */
	public function init() {
		// All starts here
		add_action( 'wp_enqueue_scripts', 	[ $this, 'front_scripts'		] );
		add_action( 'wp_enqueue_scripts', 	[ $this, 'localize_js' 			], 90 );
		add_action( 'wp_default_scripts', 	[ $this, 'jquery_to_footer' 	] );
		//add_filter( 'script_loader_tag', 	[ $this, 'maybe_enable_attrs' 	], 10, 3 );
	}

	/**
	 * WeCodeArt JS Object
	 *
	 * @since	3.2
	 * @version	3.6.3
	 *
	 * @return 	void
	 */
	public function localize_js() {
		global $wp_scripts;

		$wecodeart = [
			'assetsEnqueue' 	=> $wp_scripts->queue, 
			'templateDirectory' => get_template_directory_uri()
		];

		if( is_child_theme() ) {
			$wecodeart['styleDirectory'] = get_stylesheet_directory_uri();
		}
		
		wp_localize_script( 'wecodeart-core', 'wecodeart', 
			apply_filters( 'wecodeart/filter/scripts/localize_js', $wecodeart ) 
		);
	}

	/**
	 * jQuery to Footer
	 *
	 * @since	3.1.2
	 * @version	3.5
	 */
	public function jquery_to_footer( $wp_scripts ) {
		if ( ! is_admin() && apply_filters( 'wecodeart/filter/scripts/jquery-in-footer', false ) ) {
			$wp_scripts->add_data( 'jquery', 			'group', 1 );
			$wp_scripts->add_data( 'jquery-core', 		'group', 1 );
			$wp_scripts->add_data( 'jquery-migrate', 	'group', 1 );
		}
	}

	/**
	 * Enqueue Front-End Styles
	 *
	 * @since	1.0
	 * @version	3.9.2
	 */
	public function front_scripts() {
		$folder = defined( 'WP_DEBUG' ) && WP_DEBUG === true ? 'unminified' : 'minified';

		// Enqueue Styles
		wp_enqueue_style( 'wecodeart-core',	get_parent_theme_file_uri( '/assets/' . $folder . '/css/style.css' ), [], '3.9.2' );

		// Enqueue scripts
		wp_enqueue_script( 'wecodeart-core', get_parent_theme_file_uri( '/assets/' . $folder . '/js/frontend.js' ), [ 'jquery' ], '3.9.2', true );		
		if ( ( is_page() || is_single() ) && comments_open() && get_option( 'thread_comments' ) ) {
			wp_enqueue_script( 'comment-reply' );
		}
	}

	/**
	 * Async / Defer.
	 *
	 * @since 3.9.3
	 *
	 * @param string $tag    The script tag, generated by WordPress.
	 * @param string $handle The handle for the registered script.
	 * @param string $src    The source URL for the script.
	 * @return string $tag The (maybe) reformatted script tag.
	 */
	public function maybe_enable_attrs( $tag, $handle, $src ) {

		$supported_attributes = [
			'async',
			'defer',
		];

		$decoded_src = wp_specialchars_decode( $src );

		$query = wp_parse_url( $decoded_src, PHP_URL_QUERY );

		if ( ! $query ) {
			return $tag;
		}

		wp_parse_str( $query, $query_args );

		foreach ( $supported_attributes as $attr ) {

			if ( isset( $query_args[ $attr ] ) && 'true' === $query_args[ $attr ] ) {

				$new_src = esc_url( remove_query_arg( $attr, $decoded_src ) );

				$tag = Markup::strip_attr( $tag, 'script', $attr );
				$tag = str_replace( ' src=', ' ' . esc_attr( $attr ) . ' src=', $tag );
				$tag = str_replace( $src, $new_src, $tag );
			}
		}

		return $tag;

	}
}